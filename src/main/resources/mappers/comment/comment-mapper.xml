<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.e.shortform.domain.comment.mapper.CommentMapper">

    <resultMap id="commentResultMap" type="com.e.shortform.domain.comment.vo.CommentVo">
        <id property="id" column="ID"/>
        <result property="commentText" column="COMMENT_TEXT"/>
        <result property="userId" column="COMMENT_USER_ID"/>
        <result property="videoId" column="COMMENT_VIDEO_ID"/>
        <result property="createAt" column="CREATE_AT"/>
        <result property="deleteStatus" column="DELETE_STATUS" />
    </resultMap>

    <resultMap id="commentWithUserVideoResultMap" type="com.e.shortform.domain.comment.res.CommentWithUserVideoDto">
        <id property="id" column="ID"/>
        <result property="commentText" column="COMMENT_TEXT"/>
        <result property="commentUserId" column="COMMENT_USER_ID"/>
        <result property="commentVideoId" column="COMMENT_VIDEO_ID"/>
        <result property="createAt" column="CREATE_AT"/>

        <association property="userVo" javaType="com.e.shortform.domain.user.vo.UserVo" />
        <association property="videoVo" javaType="com.e.shortform.domain.video.vo.VideoVo" />
    </resultMap>

    <resultMap id="commentWithUserVideoFfuucckkResultMap" type="com.e.shortform.domain.comment.res.CommentUserFindWhatTheFuckDto">
        <id property="id" column="COMMENT_ID"/>
        <result property="commentText" column="COMMENT_TEXT"/>
        <result property="commentUserId" column="COMMENT_USER_ID"/>
        <result property="commentVideoId" column="COMMENT_VIDEO_ID"/>
        <result property="createAt" column="CREATE_AT"/>
        <result property="username" column="USERNAME"/>
        <result property="profileImgSrc" column="PROFILE_IMG_SRC"/>
        <result property="mention" column="MENTION"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="replyCount" column="REPLY_COUNT" />
    </resultMap>

    <select id="selectByCommentId" resultMap="commentWithUserVideoFfuucckkResultMap" parameterType="Long">
        SELECT
            C.ID AS COMMENT_ID,
            C.COMMENT_TEXT,
            C.COMMENT_USER_ID,
            C.COMMENT_VIDEO_ID,
            C.CREATE_AT,
            U.USERNAME,
            U.PROFILE_IMG_SRC,
            U.MENTION,
            NVL(L.LIKE_COUNT, 0) AS LIKE_COUNT,
            NVL(R.REPLY_COUNT, 0) AS REPLY_COUNT -- 이 댓글에 달린 답글 총 개수
        FROM SHORTFORM_COMMENTS C
                 JOIN SHORTFORM_USERS U ON C.COMMENT_USER_ID = U.ID
                 LEFT JOIN (
            SELECT COMMENT_ID, COUNT(*) AS LIKE_COUNT
            FROM SHORTFORM_COMMENT_LIKES
            GROUP BY COMMENT_ID
        ) L ON C.ID = L.LIKE_COUNT -- ID 매칭 확인 필요
                 LEFT JOIN (
            -- 답글 테이블에서 댓글ID별로 개수를 미리 집계
            SELECT COMMENT_REPLY_ID, COUNT(*) AS REPLY_COUNT
            FROM SHORTFORM_COMMENT_REPLYS
            GROUP BY COMMENT_REPLY_ID
        ) R ON C.ID = R.COMMENT_REPLY_ID
        WHERE C.COMMENT_VIDEO_ID = #{id}
        ORDER BY C.CREATE_AT DESC -- 최신순 또는 좋아요순
    </select>
    
    <select id="selectByCommentButOrderByIsDesc" resultMap="commentWithUserVideoFfuucckkResultMap" parameterType="Long">
        SELECT
            C.ID AS COMMENT_ID,
            C.COMMENT_TEXT,
            C.COMMENT_USER_ID,
            C.COMMENT_VIDEO_ID,
            C.CREATE_AT,
            U.USERNAME,
            U.PROFILE_IMG_SRC,
            U.MENTION,
            L.LIKE_COUNT AS LIKE_COUNT
        FROM
            SHORTFORM_COMMENTS C
                JOIN
            SHORTFORM_USERS U ON C.COMMENT_USER_ID = U.ID
                LEFT JOIN (
                SELECT COMMENT_ID, COUNT(*) AS LIKE_COUNT
                FROM SHORTFORM_COMMENT_LIKES
                GROUP BY COMMENT_ID
            ) L ON C.ID = L.COMMENT_ID
        WHERE
            C.COMMENT_VIDEO_ID = #{id}
        ORDER BY
            C.CREATE_AT DESC
    </select>

</mapper>